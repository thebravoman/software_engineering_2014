require "csv"
results = Hash.new{|hash, key| hash[key] = [0,0,0,0,0,0]}
teams_hash=Hash.new{|hash, key| hash[key] = []}
time_hash=Hash.new{|hash, key| hash[key] = []}
p = Hash.new
dir = ARGV[0] + "class009_homework/"
folder = 0

firstLine = "FirstName LastName","002","003","004","009","012"
folder_name = ["class002_homework", "class003_homework","class004","class009_homework","class012_homework"]

(0..3).each do |j|
	Dir.glob(ARGV[0]+"/#{folder_name[j]}/*.*").each do |repository|
		case j
#			when 0 then git_log = `git log --until=17.09.2014:20:00:00 #{repository}` 
			when 0 then git_log = `git log --until=22.09.2014:20:00:00 #{repository}` 
			when 1 then git_log = `git log --until=24.09.2014:20:00:00 #{repository}` 
			when 2 then git_log = `git log --until=29.09.2014:20:00:00 #{repository}` 
			when 4 then git_log = `git log --until=27.10.2014:20:00:00 -- #{repository}` 
			when 3 then git_log = `git log --until=10.11.2014:20:00:00 #{repository}` 
		end	
		script_file1 = repository.split("/").last.reverse.split("_", 3).last.reverse.gsub("_"," ")
		
#		if (j == 0) # then ??
		if !git_log.empty?
			 results[script_file1][folder] = 2
		elsif git_log.empty?
			 results[script_file1][folder] = 1	
		end
		if j == 4
			f = File.open("#{dir}project_to_names.csv", "r")
			f.each do |line|
				if line.start_with? ',' 
				elsif !line.include?("Progect Name")
			  		team = line.split(",").first
					names = line.split(",").last
					teams_hash[team] << names.gsub("\n","")
				end
			end
			f.close

			Dir.glob("#{dir}"+"*").each do |report|
			team_name = report.split(/\//).last.split(".").first
			log = `git log --until=Mon--Oct--27--20:00:00--2014 #{report}`
				if !log.empty?
					#print "ON TIME"
					team_name = report.split(/\//).last.split(".").first
					time_hash[team_name] << "2"
				elsif log.empty?
					#print "NOT ON TIME"
					team_name1 = report.split(/\//).last.split(".").first
					time_hash[team_name1] << "1"
				end
			end
			teams_hash.each do |team, names|
				time_hash.each do |team1, time|
					if team == team1
						names.each {|n|	p[n] = time}
					end
				end
			end
		end
	end
	folder += 1
end
CSV.open("result.csv", "w") do |csv|
	p.sort.each do |x,y|
		csv <<[x,y].flatten
	end
end
CSV.open("results.csv","w") do |csv|
	csv << firstLine
	results.keys.sort.each do |key|
 		csv << [key, results[key]].flatten
 	end
end
